var app=angular.module("app.questionnaire",["app.config","ui.router","app.django","app.utils","app.filter"]),$django=angular.injector(["app.django"]),$funcs=angular.injector(["app.utils"]),tmpl=$django.get("tmpl"),static_url=$django.get("static_url");app.config(["$interpolateProvider",function(e){e.startSymbol("{-"),e.endSymbol("-}")}]),app.factory("$",["$window",function(e){return e.jQuery.noConflict()}]);var pbLib=$funcs.get("pbLib"),confirmBox=$funcs.get("confirmBox"),confirmBoxRed=$funcs.get("confirmBoxRed"),alertBox=$funcs.get("alertBox"),getModeData=$funcs.get("getModeData"),postModeData=$funcs.get("postModeData"),inArray=$funcs.get("inArray"),pbFunc=$funcs.get("pbFunc");app.config(["$stateProvider","$urlRouterProvider",function(e,t){var o="/";t.otherwise(o),e.state("default",{url:"/",template:"",controller:"questionnaire"})}]),app.controller("questionnaire",["$rootScope","$scope","$http","$state",function(e,t,o,n){}]),app.directive("questionlistDirective",function(){return{scope:{qrUrl:"="},controller:["$rootScope","$scope","$element","$attrs","$transclude","$http","$state",function(e,t,o,n,s,r,a){var u,p=[];t.posted=!1,t.QRshow=!1;var c=!0;t.localData={questions:{},questionTypes:[]};var _=getModeData(r,"/activity/questions/","",function(e){t.products=e,l("products","localData")},void 0,function(){_.abort(),alert("an unexpected error ocurred!")},void 0),l=function(e,o){u=t[e].question_types_count;var n=t[e].question_types;for(t[o].questionTypes=n,t[o].question_types_zh_CN=t[e].question_types_zh_CN,t[o].questionNumber=t[e].questions.length,i=0;i<u;i++){t[o].questions[n[i]]=[];for(var s=0,r=t[e].questions.length;r>s;s++){var a={};if(t[e].questions[s].question_type==n[i]){if(a={},a.question_id=t[e].questions[s].question_id,a.answer_type=t[e].questions[s].anwser_type,a.answers_count=t[e].questions[s].anwsers_count,a.answer_options=[],a.order=t[e].questions[s].order,a.is_other_option=t[e].questions[s].is_other_option,a.answer_word="",a.wrong_show=!0,a.question=t[e].questions[s].question,a.other_opinion_selected=!1,"single_choies"==a.answer_type||"single_choies_or_text"==a.answer_type||"multi_choies"==a.answer_type||"multi_choies_or_text"==a.answer_type){var p={};for(answer in t[e].questions[s].anwser_options)t[e].questions[s].anwser_options.hasOwnProperty(answer)&&(p={},p.name=t[e].questions[s].anwser_options[answer],p.selected=!1,a.answer_options.push(p));delete p}"address"==a.answer_type&&(a.answer_word=["","",""]),t[o].questions[n[i]].push(a),delete a}}}},w=function(e){for(var o=0,n=e.length;n>o;o++)if(""==e[o].answer){c=!1;break}t.posted=!0},f=function(e){e.wrong_show=!0;var t=!0;if("address"==e.answer_type){for(var o=0,n=e.answer_word.length;n>o;o++)if(""==e.answer_word[o]){t=!1;break}1==t&&(e.wrong_show=!1)}else if("single_choies"==e.answer_type||"single_choies_or_text"==e.answer_type||"multi_choies"==e.answer_type||"multi_choies_or_text"==e.answer_type){for(var o=0,n=e.answer_options.length;n>o;o++)if(1==e.answer_options[o].selected){e.wrong_show=!1;break}1==e.is_other_option&&""!==e.answer_word&&(e.wrong_show=!1)}else("long_text"==e.answer_type||"short_text"==e.answer_type)&&""!==e.answer_word&&(e.wrong_show=!1)};t.actualtime=function(e){f(e)},t.showjudge=function(e,t){return e},t.singleSelect=function(e,t){if("other"==t){for(var o=e.answers_count-1;o>=0;o--)e.answer_options[o].selected=!1;e.other_opinion_selected=!0}else for(var n=e.answers_count-1;n>=0;n--)if(t==n){for(var o=e.answers_count-1;o>=0;o--)e.answer_options[o].selected=!1;e.other_opinion_selected=!1,e.answer_options[n].selected=!0;break}f(e)},t.multiSelect=function(e,t){if("other"==t)e.other_opinion_selected=!e.other_opinion_selected;else for(var o=e.answers_count-1;o>=0;o--)t==o&&(e.answer_options[o].selected=!e.answer_options[o].selected);f(e)};var d=function(e,o){var n=[];for(obj in t[e].questions)if(t[e].questions.hasOwnProperty(obj))for(var s=0,r=t[e].questions[obj].length;r>s;s++)n.push(t[e].questions[obj][s]);for(var s=0,r=n.length;r>s;s++)if("address"==n[s].answer_type){for(var i=!0,a=0,u=n[s].answer_word.length;u>a;a++)""==n[s].answer_word[a]&&(i=!1);i?n[s].postAnswer=n[s].answer_word.join(","):n[s].postAnswer=""}else if("single_choies"==n[s].answer_type||"single_choies_or_text"==n[s].answer_type||"multi_choies"==n[s].answer_type||"multi_choies_or_text"==n[s].answer_type){n[s].postAnswer=[];for(var a=0,u=n[s].answer_options.length;u>a;a++)1==n[s].answer_options[a].selected&&n[s].postAnswer.push(n[s].answer_options[a].name);1==n[s].other_opinion_selected&&n[s].postAnswer.push(n[s].answer_word),n[s].postAnswer=n[s].postAnswer.join(",")}else n[s].postAnswer=n[s].answer_word;for(var s=0,r=t[e].questionNumber-1;r>=s;s++){var p={};p.question_id=n[s].question_id,p.answer=n[s].postAnswer,o.push(p)}o=o.join(","),o=JSON.stringify(o)};t.saveFolder=function(){p=[],d("localData",p),w(p);var e='<div style="margin: 0 auto;width: 400px;"><div class="f16 text-center"><i class="i-l-notice"></i>表单内容提交后不可修改</div>';$.alert(e,"","",{handlers:[{title:"返回修改",eventType:"click",className:"button button-normal w158 f16",event:function(){$._LayerOut.close()}},{title:"确定",eventType:"click",className:"button button-primary w158 f16",event:function(){if(!c)return $.alert('<p style="text-align:center;font-size:25px;color:#77c7ef;">请将调查问卷填写完整后保存</p>'),c=!0,!1;if(p.length>0)var e=postModeData(r,{anwsers:p},"/activity/questionnaire_feedback/","",function(e){"ok"==e.status&&(document.location.href="/")},void 0,function(t){e.abort()},"json");$._LayerOut.close()}}]})},t.changeQR=function(){0==t.QRshow?t.QRshow=!0:t.QRshow=!1}}],restrict:"E",templateUrl:tmpl("activity/questionnaire/quesList.html"),replace:!0,link:function(e,t,o,n){}}});