function minusOne(e){e.each(function(){var e=$(this),t=parseInt(e.html(),10)-1;0>=t&&(t=""),e.html(t)})}function setNum(e,t){e.each(function(){0>=t&&(t=""),$(this).html(t)})}$(function(e){function t(e){return parseInt(e,10)}window.confirmBox=function(){function e(e){return(e=+e)<10?"0"+e:e}function t(){var t=new Date;return[t.getFullYear(),e(t.getMonth()+1),e(t.getDate())].join("-")}function n(){var e=t(),n=new Date(e);return n.setDate(+e.split("-")[2]+1),n.toJSON().split("T")[0]}var i=$(".confirm-box");i.find('input[type="date"]').val(n());var o=!0,r="";return{show:function(e){var t=$(".selected-item").length||0;i.show().find("span.selected-num").html(t),$(".confirm-action").hide(),$(".action-"+e).show(),o=!1,r=e},toggle:function(e){o?this.show(e):r!=e?this.show(e):this.hide()},hide:function(){i.hide(),o=!0}}}();var n,i,o=$.extend({},{html:"",style:"preview-info-default",width:"650px",height:"450px"},e||{}),r=$(window),a=600,d=$('<div class="preview-info-default"><div style="margin:0;padding:0;position:ralative;width:100%;height:100%" class="info_wrapper"><b style="margin:0;padding:0;background-position:5px center; background-repeat:no-repeat;position:absolute;left:-15px;top:8%;width:15px;height:17px;" class="info_arrow"></b><div style="margin:0;padding:0;" class="info_content"></div></div></div>'),s=$("<div/>").appendTo("body").hide();$(".feed-page").on("xmouseenter",".feed-item",function(){var e,c,u,f,l,m,p,h=$(this),g=t(o.width),v=t(o.height),_=12;return h.find(".control-pending").length?(clearTimeout(i),!1):void(i=setTimeout(function(){return n&&clearTimeout(n),h.find(".control-pending").length?!1:(d.appendTo("body").css({position:"absolute","z-index":1e5}).width(g-t(d.css("padding-left"))-t(d.css("padding-right"))-t(d.css("border-left-width"))-t(d.css("border-right-width"))).height(v-t(d.css("padding-top"))-t(d.css("padding-bottom"))-t(d.css("border-top-width"))-t(d.css("border-bottom-width"))),p=d.find(".info_arrow"),e=(u=h.offset().left)+h.outerWidth()+_,e+(l=d.outerWidth())>r.width()&&(p.css({"background-position":"-20px 0",left:"",right:"-15px"}),e=u-l-_),c=f=h.offset().top,c+(m=d.outerHeight())-r.scrollTop()>r.height()&&(p.css({top:"",bottom:"8%"}),c=f-m+h.outerHeight()),d.css({top:c,left:e}).find(".info_content").html(o.html).end().hover(function(){n&&clearTimeout(n)},function(){n=setTimeout(function(){d.remove()},300)}),void setTimeout(function(){var e=h.find(".item-body>a").attr("href");s.load(e+" #main",function(){s.find("#main").removeAttr("id").removeAttr("class"),s.find(".contact-info").remove(),s.find("#resume-detail-header").remove(),s.find(".contact-info").remove(),s.find(".aside").remove(),s.find(".btn-toggle").remove(),d.find(".info_content").html(s.html())})},100))},$(".preview-info-default").length&&400||a))}),$(".feed-page").on("mouseleave",".feed-item",function(){clearTimeout(i),n=setTimeout(function(){d.remove()},400)})}),$(document).keyup(function(e){27==e.keyCode&&$(".preview-info-default").length&&$(".preview-info-default").remove()});var feedApp=angular.module("feedApp",[]);feedApp.config(["$interpolateProvider",function(e){e.startSymbol("{[{"),e.endSymbol("}]}")}]),feedApp.config(["$routeProvider",function(e){var t=$("#template-feeditem").html();e.when("/group/:id",{template:t,controller:"feedPage"});var n=$(".feed-group-link").first(),i="/";n.length&&(i=n.attr("href").substr(1)),e.otherwise({redirectTo:i})}]),feedApp.factory("Feed",["$http",function(e){var t=window.location.pathname||"",n="cached";return"/statis/feed_result/"===t&&(n="cached"),{group:function(t,n,i,o,r,a){if("all"===t){var d=$(".feed-group-link").first(),s="/";return d.length&&(s=d.attr("href").substr(1)),void(window.location="#"+s)}return e.get("/feed/group/"+t+"?start="+n+"&latest="+i+"&orderby="+r+"&limit=10&view="+o+"&t="+ +new Date).then(function(e){return e.data}).then(a)},current:{id:"",view:n,start:0,latest:1,total_count:0,orderby:"resume_update_time",total_recommend_count:0,scope:{}}}}]).factory("Auto",["$http",function(e){return function(t){return e.get("/resumes/all_tags").then(function(e){return e.data}).then(t)}}]),feedApp.filter("gender",function(){return function(e){return"female"==e?"女":"男"}}).filter("checkFeedOpen",function(){return function(e){return e?"":"feed-unread"}}).filter("checkFeedLatest",function(){return function(e){return e?"feed-latest":""}}).filter("chop",function(){return function(e){return e.length>150&&(e=e.substr(0,147)+"</br>..."),e}}),feedApp.directive("clickedit",function(){return{restrict:"A",transclude:!0,scope:!0,template:['<span ng-hide="editing" ng-transclude style="padding-right:10px;line-height:23px">','<i class="prop-action" ng-click="editing=true"></i>',"</span>",'<span ng-show="editing" style="line-height:31px;display: inline-block;position:relative;top: -4px;" class="clickdit">','<input autofocus type="text" list="tagHistory" ng-model="_text" style="border: 0; padding: 5px; background:f5f5f5; border: 1px solid #eee; width:100px;box-shadow: inset 0px 1px rgba(0,0,0,.1)"/>','<a href="" style="color:#111; margin-left:5px;" ng-click="ok($event)">确定</a><a href="" style="color:#111;margin-left:5px;" ng-click="cancel()">取消</a>',"</span>"].join(""),link:function(e,t,n){e.text=n.clickedit,e.feed_id=n.feed_id,e.resume_id=n.resume_id},controller:["$scope","$timeout",function(e,t){e.$watch("editing",function(){e.editing&&(e._text="")}),e.isAll=function(t){return e.isall="resume"==t},e.ok=function(n){$(n.target).parent().find("input");if(e.editing=!1,!e._text)return!1;e.item.tags||(e.item.tags=[]);for(var i=0;i<e.item.tags.length;++i)if(e.item.tags[i].tag.toLowerCase()==$.trim(e._text).toLowerCase())return alert("标签已存在"),!1;$.post("/resumes/add_tag_resume",{tag_id:window.autoHistoryMap[e._text]||"",tag:e._text,resume_id:e.item.resume_id},function(n){return n?void(n&&"success"==n.status?t(function(){e.item.tags||(e.item.tags=[]),e.item.tags.push({tag_id:n.tag_id,tag:e._text}),window.autoHistoryMap[e._text]||e.autoHistory.push({tag_id:n.tag_id,tag:e._text}),window.autoHistoryMap[e._text]=n.tag_id,e._text=""}):(alert("添加失败，请联系瑶哥!"),t(function(){e.item.tags.pop()}))):!1})},e.cancel=function(){e.editing=!1}}]}}),feedApp.directive("fixedtop",function(){return{restrict:"A",link:function(e,t,n){var i=n.fixedtop||0,o=$(t).offset().top,r=$(t),a=$(window),d=r.css("position");a.on("scroll",function(){a.scrollTop()>=o-i?r.css({position:"fixed",top:i+"px"}):r.css({position:d,top:"auto"})})}}});var $more=$(".load-more");feedApp.controller("aside",["$scope","$location",function(e,t){e.isActive=function(e){return-1!=t.path().indexOf(e)}}]).controller("resumeTag",["$scope","$location","$timeout",function(e,t,n){e.delTag=function(t,i){$.post("/resumes/del_tag_resume",{tag_id:t.tag_id,resume_id:i},function(i){i&&"success"==i.status?n(function(){for(var n=0;n<e.item.tags.length;++n)e.item.tags[n].tag_id==t.tag_id&&e.item.tags.splice(n,1)}):alert("操作失败了，请联系瑶哥")})}}]).controller("feedApp",["$scope","Feed","Auto","$timeout",function(e,t,n,i){n(function(t){e.autoHistory=t.data||[],window.autoHistoryMap={},angular.forEach(e.autoHistory,function(e){window.autoHistoryMap[e.tag]=e.tag_id})}),e.current=t.current,e.toggleLatest=function(t){e.current.latest?e.current.latest=0:e.current.latest=1,setTimeout(function(){var e=$(".feed-nav .curr").find("a"),t=e.attr("href");window.location.replace(t.split("?")[0]+"?"+Math.random().toString(16).substr(2))},800)},e.toggleOrderby=function(t){/^\-/.test(e.current.orderby)?e.current.orderby="resume_update_time":e.current.orderby="-resume_update_time",setTimeout(function(){var e=$(".feed-nav .curr").find("a"),t=e.attr("href");window.location.replace(t.split("?")[0]+"?"+Math.random().toString(16).substr(2))},800)},e.toggleView=function(t,n){return e.current.view==t?!1:(e.current.view=t||"user",void setTimeout(function(){var e=$(".feed-nav .curr").find("a"),t=e.attr("href")||"";window.location.replace(t.split("?")[0]+"?"+Math.random().toString(16).substr(2))},800))},e.publishAll=function(e){var t=$.trim($(".feed-aside").find("h2[data-username]>span").html()),n=$(".confirm-box").find('input[type="date"]').val()||"";return confirmBox.hide(),t?void $.post("/feed/publish_new_reco",{username:t,pub_time:n,published:!0},function(e){e&&e.status?alert("全部发布 OK. 发布了"+e.data.number+"个 耗时:"+e.data.cost_time+"秒."):alert("oh no! 操作失败")}):alert("没有获取到用户名，请联系开发")},e.publishFeed=function(){var e=$(".feed-nav").find(".curr>span").data("count-group"),t=$(".confirm-box").find('input[type="date"]').val()||"";confirmBox.hide();var n=[];return $(".selected-item").each(function(){n.push($(this).data("resume_id"))}),n.length?void $.post("/feed/publish_new_reco",{feed_id:e,pub_time:t,resume_ids:n,published:!0},function(e){e&&e.status?alert("全部发布 OK. 发布了"+e.data.number+"个 耗时:"+(""+e.data.cost_time).substr(0,5)+"秒."):alert("oh no! 操作失败")}):alert("请先选择要推荐的简历！")}}]).controller("feedPage",["$scope","Feed","Auto","$timeout","$routeParams","$rootScope",function(e,t,n,i,o,r){t.current.id=o.id,t.current.start=0,t.current.limit=5,e.fetch=function(n){e.loadmore=!0,e.hasmore=!1,t.group(t.current.id,t.current.start,t.current.latest,t.current.view,t.current.orderby,function(n){i(function(){return e.feeditems.push.apply(e.feeditems,n.data),t.current.start=n.next_start,e.loadmore=!1,"-1"!=n.next_start&&(e.hasmore=!0),"all"==$(".feed-nav li.curr").find(".feed-latest-count").data("count-group")?!1:void(e.current.latest?setNum($(".feed-nav li.curr").find(".feed-latest-count"),n.newest_recommend_count):n.newest_recommend_count&&_.filter(n.data||[],function(e){return!!e.latest}).length&&setNum($(".feed-nav li.curr").find(".feed-latest-count"),n.newest_recommend_count))})})},i(function(){e.initLoading=!0,e.loadmore=!1,e.hasmore=!1,e.waiting=!1}),t.current.id&&t.group(t.current.id,t.current.start,t.current.latest,t.current.view,t.current.orderby,function(n){i(function(){return e.feeditems=n.data,e.initLoading=!1,t.current.total_count=n.total_count,t.current.total_recommend_count=n.total_recommend_count,t.current.start=n.next_start,"-1"!=n.next_start&&(e.hasmore=!0),n.count&&n.data.length||(e.waiting=!0,e.hasmore=!1),"all"==$(".feed-nav li.curr").find(".feed-latest-count").data("count-group")?!1:void(e.current.latest?setNum($(".feed-nav li.curr").find(".feed-latest-count"),n.newest_recommend_count):n.newest_recommend_count&&_.filter(n.data||[],function(e){return!!e.latest}).length&&setNum($(".feed-nav li.curr").find(".feed-latest-count"),n.newest_recommend_count))})}),e.openFeed=function(e,t){},e.dislike=function(t){$.get("/feed/modify_feed_result",{feed_id:e.feeditems[t].feed_id,resume_id:e.feeditems[t].resume_id,reco_index:"-100"}),i(function(){e.feeditems[t].dislike=!0,e.feeditems[t].latest=!1,e.feeditems[t].opened=!0})},e.adminVote=function(t,n){$(".preview-info-default").length&&$(".preview-info-default").remove();var i=$(n.target);i.parent().addClass("control-pending"),i.parent().hasClass("control-voted")?$.get("/feed/modify_feed_result",{feed_id:e.feeditems[t].feed_id,resume_id:e.feeditems[t].resume_id,reco_index:"-150"},function(){i.parent().removeClass("control-pending").removeClass("control-voted")}):$.get("/feed/modify_feed_result",{feed_id:e.feeditems[t].feed_id,resume_id:e.feeditems[t].resume_id,reco_index:"150"},function(){i.parent().removeClass("control-pending").addClass("control-voted")})},e.adminBlock=function(t,n){$(".preview-info-default").length&&$(".preview-info-default").remove();var o=$(n.target);o.parent().addClass("control-pending"),$.get("/feed/modify_feed_result",{feed_id:e.feeditems[t].feed_id,resume_id:e.feeditems[t].resume_id,reco_index:"-100"},function(){o.parent().removeClass("control-pending"),o.parents(".feed-item").addClass("shrink"),i(function(){e.feeditems.splice([t],1)},500)})}}]),$(function(){var e=$("#feed-submit-form");e.find(".options").each(function(){var e=$(this),t=e.data("name"),n=$('input[name="'+t+'"]');e.parent().find("span").on("click",function(){e.hasClass("op-multi")?$(this).toggleClass("selected"):e.hasClass("op-single")&&($(this).parents("li").find(".selected").removeClass("selected"),$(this).addClass("selected")),n.val(e.parent().find(".selected").map(function(){return $.trim($(this).html())}).toArray().join(","))})}),$(".select-btn-more>a").on("click",function(e){e.preventDefault();var t=$(this);$(".select-expect-area").toggleClass("expect-area-span").find(".op-multi").slideToggle(200);var n=$.trim(t.html());t.html(t.data("text-span")),t.data("text-span",n)}),$('a[href^="/feed/delete"]').on("click",function(e){var t=window.confirm("删除订阅条件将清除此订阅下的所有简历！是否继续？");return t?void 0:!1}),$("#give-me-feed").on("click",function(){e.submit()}),$(".feed-edit-jd >form").on("submit",function(e){e.preventDefault();var t=$(this),n=t.attr("action"),i=t.find('textarea[name="job_desc"]').val();if(i==window.feed_edit_jd_old)return t.find('textarea[name="job_desc"]').focus(),!1;var o=t.find('button[type="submit"]').html("正在保存");o.addClass("submitting"),$.post(n,{job_desc:i},function(e){o.removeClass("submitting"),o.html("保存"),e&&e.status?(window.feed_edit_jd_old=i,o.prev().remove(),$('<span style="margin-right: 10px; color:green;">已保存!</span>').insertBefore(o).fadeOut(1500,function(){$(this).remove()})):(o.prev().remove(),$('<span style="margin-right: 10px; color:red;">保存失败，请重试!</span>').insertBefore(o).fadeOut(3e3,function(){$(this).remove()}))})});var t;$("body").on("mouseover",".resume-tags-hook",function(){clearTimeout(t),$(this).parents(".item-header").find(".item-action-keywords").fadeIn()}).on("mouseout",".resume-tags-hook, .item-action-keywords",function(){t=setTimeout(function(){$(".item-action-keywords").hide()},400)}).on("mouseover",".item-action-keywords",function(){clearTimeout(t)}),function(){var e=$(document);$(window).on("scroll",function(){var t=$('a[ng-show="hasmore"]');if(!t.is(":hidden")){var n=e.height()-e.scrollTop()-$(window).height();100>n&&t.get(0).click()}})}(),$(".btn-unselect").on("click",function(){$(this).parent().find("input").val(0),$(".selected-item").removeClass("selected-item"),$(".selectBox").removeAttr("checked")}),$('.sub-control input[type="number"]').on("change",function(e){var t=parseInt($(this).val(),10);$(".selected-item").removeClass("selected-item"),$(".feed-item").each(function(e,n){t>e&&($(this).addClass("selected-item"),$(this).find(".selectBox").attr("checked","checked"))})}),$(".toggleConfirm").on("click",function(){var e=$(this).data("type");confirmBox.toggle(e)}),$("body").on("change",".selectBox",function(){$(this).parents(".feed-item").toggleClass("selected-item")})});