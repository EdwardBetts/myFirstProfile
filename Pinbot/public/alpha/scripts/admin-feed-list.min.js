function minusOne(e){e.each(function(){var e=$(this),t=parseInt(e.html(),10)-1;0>=t&&(t=""),e.html(t)})}function setNum(e,t){e.each(function(){0>=t&&(t=""),$(this).html(t)})}$(function(e){function t(e){return parseInt(e,10)}window.confirmBox=function(){function e(e){return(e=+e)<10?"0"+e:e}function t(){var t=new Date;return[t.getFullYear(),e(t.getMonth()+1),e(t.getDate())].join("-")}function n(){var e=t(),n=new Date(e);return n.setDate(+e.split("-")[2]+1),n.toJSON().split("T")[0]}var o=$(".confirm-box");o.find('input[type="date"]').val(n());var i=!0,r="";return{show:function(e){var t=$(".selected-item").length||0;o.show().find("span.selected-num").html(t),$(".confirm-action").hide(),$(".action-"+e).show(),i=!1,r=e},toggle:function(e){i?this.show(e):r!=e?this.show(e):this.hide()},hide:function(){o.hide(),i=!0}}}();var n,o,i=$.extend({},{html:"",style:"preview-info-default",width:"650px",height:"450px"},e||{}),r=$(window),a=600,s=$('<div class="preview-info-default"><div style="margin:0;padding:0;position:ralative;width:100%;height:100%" class="info_wrapper"><b style="margin:0;padding:0;background-position:5px center; background-repeat:no-repeat;position:absolute;left:-15px;top:8%;width:15px;height:17px;" class="info_arrow"></b><div style="margin:0;padding:0;" class="info_content"></div></div></div>'),d=$("<div/>").appendTo("body").hide();$(".feed-page").on("xmouseenter",".feed-item",function(){var e,c,u,l,f,m,p,h=$(this),g=t(i.width),v=t(i.height),_=12;return h.find(".control-pending").length?(clearTimeout(o),!1):void(o=setTimeout(function(){return n&&clearTimeout(n),h.find(".control-pending").length?!1:(s.appendTo("body").css({position:"absolute","z-index":1e5}).width(g-t(s.css("padding-left"))-t(s.css("padding-right"))-t(s.css("border-left-width"))-t(s.css("border-right-width"))).height(v-t(s.css("padding-top"))-t(s.css("padding-bottom"))-t(s.css("border-top-width"))-t(s.css("border-bottom-width"))),p=s.find(".info_arrow"),e=(u=h.offset().left)+h.outerWidth()+_,e+(f=s.outerWidth())>r.width()&&(p.css({"background-position":"-20px 0",left:"",right:"-15px"}),e=u-f-_),c=l=h.offset().top,c+(m=s.outerHeight())-r.scrollTop()>r.height()&&(p.css({top:"",bottom:"8%"}),c=l-m+h.outerHeight()),s.css({top:c,left:e}).find(".info_content").html(i.html).end().hover(function(){n&&clearTimeout(n)},function(){n=setTimeout(function(){s.remove()},300)}),void setTimeout(function(){var e=h.find(".item-body>a").attr("href");d.load(e+" #main",function(){d.find("#main").removeAttr("id").removeAttr("class"),d.find(".contact-info").remove(),d.find("#resume-detail-header").remove(),d.find(".contact-info").remove(),d.find(".aside").remove(),d.find(".btn-toggle").remove(),s.find(".info_content").html(d.html())})},100))},$(".preview-info-default").length&&400||a))}),$(".feed-page").on("mouseleave",".feed-item",function(){clearTimeout(o),n=setTimeout(function(){s.remove()},400)})}),$(document).keyup(function(e){27==e.keyCode&&$(".preview-info-default").length&&$(".preview-info-default").remove()});var feedApp=angular.module("feedApp",[]);feedApp.config(["$interpolateProvider",function(e){e.startSymbol("{[{"),e.endSymbol("}]}")}]),feedApp.config(["$routeProvider",function(e){var t=$("#template-feeditem").html();e.when("/group/:id",{template:t,controller:"feedPage"});var n=$(".feed-group-link").first(),o="/";n.length&&(o=n.attr("href").substr(1)),e.otherwise({redirectTo:o})}]),feedApp.factory("Feed",["$http",function(e){var t=window.location.pathname||"",n="cached";return"/statis/feed_result/"===t&&(n="cached"),{group:function(t,n,o,i,r,a,s,d){if("all"===t){var c=$(".feed-group-link").first(),u="/";return c.length&&(u=c.attr("href").substr(1)),void(window.location="#"+u)}return e.get("/special_feed/verify_list/"+t+"?start="+n+"&latest="+o+"&orderby="+r+"&order_by_job="+a+"&is_manual="+s+"&limit=10&view="+i+"&t="+ +new Date).then(function(e){return e.data}).then(d)},current:{id:"",view:n,start:0,latest:1,total_count:0,orderby:"resume_update_time",order_by_job:"-job_related",is_manual:"no",total_recommend_count:0,scope:{}}}}]).factory("Auto",["$http",function(e){return function(t){return e.get("/resumes/all_tags").then(function(e){return e.data}).then(t)}}]),feedApp.filter("gender",function(){return function(e){return"female"==e?"女":"男"}}).filter("default",function(){return function(e,t){return value?value:t}}).filter("checkFeedOpen",function(){return function(e){return"read"===e?"":"feed-unread"}}).filter("checkFeedLatest",function(){return function(e){return e?"feed-latest":""}}).filter("searchKeyword",function(){return function(e){return"string"==typeof e?e:""}}).filter("manual_status",function(){return function(e){return e.admin?e.admin:""}}).filter("chop",function(){return function(e){return e&&e.length>150&&(e=e.substr(0,147)+"</br>..."),e}}),feedApp.directive("clickedit",function(){return{restrict:"A",transclude:!0,scope:!0,template:['<span ng-hide="editing" ng-transclude style="padding-right:10px;line-height:23px">','<i class="prop-action" ng-click="editing=true"></i>',"</span>",'<span ng-show="editing" style="line-height:31px;display: inline-block;position:relative;top: -4px;" class="clickdit">','<input autofocus type="text" list="tagHistory" ng-model="_text" style="border: 0; padding: 5px; background:f5f5f5; border: 1px solid #eee; width:100px;box-shadow: inset 0px 1px rgba(0,0,0,.1)"/>','<a href="" style="color:#111; margin-left:5px;" ng-click="ok($event)">确定</a><a href="" style="color:#111;margin-left:5px;" ng-click="cancel()">取消</a>',"</span>"].join(""),link:function(e,t,n){e.text=n.clickedit,e.feed_id=n.feed_id,e.resume_id=n.resume_id},controller:["$scope","$timeout",function(e,t){e.$watch("editing",function(){e.editing&&(e._text="")}),e.isAll=function(t){return e.isall="resume"==t},e.ok=function(n){$(n.target).parent().find("input");if(e.editing=!1,!e._text)return!1;e.item.tags||(e.item.tags=[]);for(var o=0;o<e.item.tags.length;++o)if(e.item.tags[o].tag.toLowerCase()==$.trim(e._text).toLowerCase())return alert("标签已存在"),!1;$.post("/resumes/add_tag_resume",{tag_id:window.autoHistoryMap[e._text]||"",tag:e._text,resume_id:e.item.resume.id},function(n){return n?void(n&&"success"==n.status?t(function(){e.item.tags||(e.item.tags=[]),e.item.tags.push({tag_id:n.tag_id,tag:e._text}),window.autoHistoryMap[e._text]||e.autoHistory.push({tag_id:n.tag_id,tag:e._text}),window.autoHistoryMap[e._text]=n.tag_id,e._text=""}):(alert("添加失败，请联系瑶哥!"),t(function(){e.item.tags.pop()}))):!1})},e.cancel=function(){e.editing=!1}}]}}),feedApp.directive("fixedtop",function(){return{restrict:"A",link:function(e,t,n){var o=n.fixedtop||0,i=$(t).offset().top,r=$(t),a=$(window),s=r.css("position");a.on("scroll",function(){a.scrollTop()>=i-o?r.css({position:"fixed",top:o+"px"}):r.css({position:s,top:"auto"})})}}});var $more=$(".load-more");feedApp.controller("aside",["$scope","$location",function(e,t){e.isActive=function(e){return-1!=t.path().indexOf(e)}}]).controller("resumeTag",["$scope","$location","$timeout",function(e,t,n){e.delTag=function(t,o){$.post("/resumes/del_tag_resume",{tag_id:t.tag_id,resume_id:o},function(o){o&&"success"==o.status?n(function(){for(var n=0;n<e.item.tags.length;++n)e.item.tags[n].tag_id==t.tag_id&&e.item.tags.splice(n,1)}):alert("操作失败了，请联系瑶哥")})}}]).controller("feedApp",["$scope","Feed","Auto","$timeout",function(e,t,n,o){n(function(t){e.autoHistory=t.data||[],window.autoHistoryMap={},angular.forEach(e.autoHistory,function(e){window.autoHistoryMap[e.tag]=e.tag_id})}),e.current=t.current,e.toggleLatest=function(t){e.current.latest?e.current.latest=0:e.current.latest=1,setTimeout(function(){var e=$(".feed-nav .curr").find("a"),t=e.attr("href");window.location.replace(t.split("?")[0]+"?"+Math.random().toString(16).substr(2))},800)},e.toggleOrderJob=function(t){/^\-/.test(e.current.order_by_job)?e.current.order_by_job="job_related":e.current.order_by_job="-job_related",setTimeout(function(){var e=$(".feed-nav .curr").find("a"),t=e.attr("href");window.location.replace(t.split("?")[0]+"?"+Math.random().toString(16).substr(2))},800)},e.toggleManual=function(t){/^yes/.test(e.current.is_manual)?e.current.is_manual="no":e.current.is_manual="yes",setTimeout(function(){var e=$(".feed-nav .curr").find("a"),t=e.attr("href");window.location.replace(t.split("?")[0]+"?"+Math.random().toString(16).substr(2))},800)},e.toggleOrderby=function(t){/^\-/.test(e.current.orderby)?e.current.orderby="resume_update_time":e.current.orderby="-resume_update_time",setTimeout(function(){var e=$(".feed-nav .curr").find("a"),t=e.attr("href");window.location.replace(t.split("?")[0]+"?"+Math.random().toString(16).substr(2))},800)},e.toggleView=function(t,n){return e.current.view==t?!1:(e.current.view=t||"user",void setTimeout(function(){var e=$(".feed-nav .curr").find("a"),t=e.attr("href")||"";""==t?alert("当前定制不存在啦～"):window.location.replace(t.split("?")[0]+"?"+Math.random().toString(16).substr(2))},800))},e.publishAll=function(e){var t=$.trim($(".feed-aside").find("h2[data-username]>span").html()),n=$(".confirm-box").find('input[type="date"]').val()||"";return confirmBox.hide(),t?void $.post("/special_feed/publish_feed/",{username:t,publish_all:!0,pub_time:n,published:!0},function(e){e?alert(e.msg):alert("oh no! 联系开发")}):alert("没有获取到用户名，请联系开发")},e.publishFeed=function(){var e=$(".feed-nav").find(".curr>span").data("count-group"),t=$(".confirm-box").find('input[type="date"]').val()||"";confirmBox.hide();var n=[];return $(".selected-item").each(function(){n.push($(this).data("resume_id"))}),n.length?void $.post("/special_feed/publish_feed/",{feed_id:e,pub_time:t,resume_ids:n,published:!0},function(e){e?alert(e.msg):alert("oh no! 联系开发")}):alert("请先选择要推荐的简历！")}}]).controller("feedPage",["$scope","Feed","Auto","$timeout","$routeParams","$rootScope",function(e,t,n,o,i,r){t.current.id=i.id,t.current.start=0,t.current.limit=5,e.fetch=function(n){e.loadmore=!0,e.hasmore=!1,t.group(t.current.id,t.current.start,t.current.latest,t.current.view,t.current.orderby,t.current.order_by_job,t.current.is_manual,function(n){o(function(){return e.feeditems.push.apply(e.feeditems,n.data),t.current.start=n.next_start,e.loadmore=!1,"-1"!=n.next_start&&(e.hasmore=!0),"all"==$(".feed-nav li.curr").find(".feed-latest-count").data("count-group")?!1:void(e.current.latest?setNum($(".feed-nav li.curr").find(".feed-latest-count"),n.newest_recommend_count):n.newest_recommend_count&&_.filter(n.data||[],function(e){return!!e.latest}).length&&setNum($(".feed-nav li.curr").find(".feed-latest-count"),n.newest_recommend_count))})})},o(function(){e.initLoading=!0,e.loadmore=!1,e.hasmore=!1,e.waiting=!1}),t.current.id&&t.group(t.current.id,t.current.start,t.current.latest,t.current.view,t.current.orderby,t.current.order_by_job,t.current.is_manual,function(n){o(function(){return e.feeditems=n.data,e.initLoading=!1,t.current.total_count=n.total_count,t.current.total_recommend_count=n.total_recommend_count,t.current.start=n.next_start,"-1"!=n.next_start&&(e.hasmore=!0),n.count&&n.data.length||(e.waiting=!0,e.hasmore=!1),"all"==$(".feed-nav li.curr").find(".feed-latest-count").data("count-group")?!1:void(e.current.latest?setNum($(".feed-nav li.curr").find(".feed-latest-count"),n.newest_recommend_count):n.newest_recommend_count&&_.filter(n.data||[],function(e){return!!e.latest}).length&&setNum($(".feed-nav li.curr").find(".feed-latest-count"),n.newest_recommend_count))})}),e.openFeed=function(e,t){},e.dislike=function(t){$.get("/feed/modify_feed_result",{feed_id:e.feeditems[t].feed.id,resume_id:e.feeditems[t].resume.id,reco_index:"-100"}),o(function(){e.feeditems[t].dislike=!0,e.feeditems[t].latest=!1,e.feeditems[t].opened=!0})},e.adminVote=function(t,n){var o=$(n.target);$(".preview-info-default").length&&$(".preview-info-default").remove(),$(".preview-info-default").length&&$(".preview-info-default").remove(),o.parent().addClass("control-pending"),o.parent().hasClass("control-voted")?$.get("/feed/modify_feed_result",{feed_id:e.feeditems[t].feed.id,resume_id:e.feeditems[t].resume.id,reco_index:"-150"},function(){o.parent().removeClass("control-pending").removeClass("control-voted")}):$.get("/feed/modify_feed_result",{feed_id:e.feeditems[t].feed.id,resume_id:e.feeditems[t].resume.id,reco_index:"150"},function(){o.parent().removeClass("control-pending").addClass("control-voted")})};var a=function(e,t){for(var n=0,o=e.length;o>n;n++)if(e[n]==t){e.splice(n,1);break}};e.adminBlock=function(e,t){},e.hoverBlock=function(e,t){var n=$(t.target),o='<div class="admin-custom-control-public admin-custom-control-refuse"><p>告诉我们不准的原因，下次会更准哦～</p><div class="clearfix js-choose-box"><a href="javascript:void(0)" data_conflict="0" data-value="salary_high">薪资偏高</a><a href="javascript:void(0)" data_conflict="0" data-value="salary_low">薪资偏低</a><a href="javascript:void(0)" data_conflict="1" data-value="level_low" class="admin-custom-control-margin">级别太低</a><a href="javascript:void(0)" data_conflict="1" data-value="level_high" class="admin-custom-control-margin">级别太高</a></div><p>还可以选择其他原因(可多选):</p><div class="clearfix js-choose-box"><a href="javascript:void(0)" data_conflict="2" data-value="degree_high">学历太高</a><a href="javascript:void(0)" data_conflict="2" data-value="degree_low">学历太低</a><a href="javascript:void(0)" data-value="title_not_match">职位名称不符</a><a href="javascript:void(0)" data-value="industry_not_match">行业不准</a><a href="javascript:void(0)" class="admin-custom-control-submit js-vote-submit">提交</a></div><div class="admin-custom-control-opacity"></div></div>',i=[],r=n.parents(".item-footer");0==$(".admin-custom-control-refuse",r).length?(r.append(o),$(".admin-custom-control-refuse",r).on("mouseleave",function(){$(".admin-custom-control-refuse",r).remove()}),$(".admin-custom-control-suit").remove(),$(".js-choose-box a").not($(".js-vote-submit")).on("click",function(){var e=$(this).attr("data-value"),t=$(this).attr("data_conflict");if($(this).hasClass("admin-custom-control-choose"))$(this).removeClass("admin-custom-control-choose"),a(i,e);else{var n='a[data_conflict="'+t+'"]',o=$(n).eq(0).attr("data-value"),r=$(n).eq(1).attr("data-value");$(n).removeClass("admin-custom-control-choose"),$(this).addClass("admin-custom-control-choose"),a(i,o),a(i,r),i.push(e)}}),$(".js-vote-submit").on("click",function(){var e=n.attr("feed-id"),t=n.attr("resume-id"),o=n.attr("index-id");i.length>0&&$.get("/feed/modify_feed_result",{feed_id:e,resume_id:t,reco_index:"-100",feedback:i},function(){n.parent().removeClass("control-pending").addClass("control-voted"),$(".admin-custom-control-suit").remove(),n.parent().removeClass("control-pending"),n.parents(".feed-item").addClass("shrink"),setTimeout(function(){var e=".feed-item-"+o;$(e).remove(),$(".feed-item").length<=0&&$(".feed-waiting").show()},400)})})):$(".admin-custom-control-refuse",r).show(),$(".preview-info-default").length&&$(".preview-info-default").remove()}}]),$(function(){var e=$("#feed-submit-form");e.find(".options").each(function(){var e=$(this),t=e.data("name"),n=$('input[name="'+t+'"]');e.parent().find("span").on("click",function(){e.hasClass("op-multi")?$(this).toggleClass("selected"):e.hasClass("op-single")&&($(this).parents("li").find(".selected").removeClass("selected"),$(this).addClass("selected")),n.val(e.parent().find(".selected").map(function(){return $.trim($(this).html())}).toArray().join(","))})}),$(".select-btn-more>a").on("click",function(e){e.preventDefault();var t=$(this);$(".select-expect-area").toggleClass("expect-area-span").find(".op-multi").slideToggle(200);var n=$.trim(t.html());t.html(t.data("text-span")),t.data("text-span",n)}),$('a[href^="/feed/delete"]').on("click",function(e){var t=window.confirm("删除订阅条件将清除此订阅下的所有简历！是否继续？");return t?void 0:!1}),$("#give-me-feed").on("click",function(){e.submit()}),$(".feed-edit-jd >form").on("submit",function(e){e.preventDefault();var t=$(this),n=t.attr("action"),o=t.find('textarea[name="job_desc"]').val();if(o==window.feed_edit_jd_old)return t.find('textarea[name="job_desc"]').focus(),!1;var i=t.find('button[type="submit"]').html("正在保存");i.addClass("submitting"),$.post(n,{job_desc:o},function(e){i.removeClass("submitting"),i.html("保存"),e&&e.status?(window.feed_edit_jd_old=o,i.prev().remove(),$('<span style="margin-right: 10px; color:green;">已保存!</span>').insertBefore(i).fadeOut(1500,function(){$(this).remove()})):(i.prev().remove(),$('<span style="margin-right: 10px; color:red;">保存失败，请重试!</span>').insertBefore(i).fadeOut(3e3,function(){$(this).remove()}))})});var t;$("body").on("mouseover",".resume-tags-hook",function(){clearTimeout(t),$(this).parents(".item-header").find(".item-action-keywords").fadeIn()}).on("mouseout",".resume-tags-hook, .item-action-keywords",function(){t=setTimeout(function(){$(".item-action-keywords").hide()},400)}).on("mouseover",".item-action-keywords",function(){clearTimeout(t)}),function(){var e=$(document);$(window).on("scroll",function(){var t=$('a[ng-show="hasmore"]');if(!t.is(":hidden")){var n=e.height()-e.scrollTop()-$(window).height();100>n&&t.get(0).click()}})}(),$(".btn-unselect").on("click",function(){$(this).parent().find("input").val(0),$(".selected-item").removeClass("selected-item"),$(".selectBox").removeAttr("checked")}),$('.sub-control input[type="number"]').on("change",function(e){var t=parseInt($(this).val(),10);$(".selected-item").removeClass("selected-item"),$(".feed-item").each(function(e,n){t>e&&($(this).addClass("selected-item"),$(this).find(".selectBox").attr("checked","checked"))})}),$(".toggleConfirm").on("click",function(){var e=$(this).data("type");confirmBox.toggle(e)}),$("body").on("change",".selectBox",function(){$(this).parents(".feed-item").toggleClass("selected-item")}),$(".js-choose-box").undelegate("a").delegate("a","click",function(){alert(1)}),$(".js-choose-box").click(function(){alert(1);var e=$(this);e.closest("div.admin-custom-control-public").hasClass("admin-custom-control-suit")&&(e.hasClass("admin-custom-control-choose")||e.addClass("admin-custom-control-choose"))})});