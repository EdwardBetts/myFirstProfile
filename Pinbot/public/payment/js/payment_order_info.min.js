function resetInput(a){a.hide().siblings(".JS_save_address").hide().siblings(".JS_edit_address").show().siblings("input").addClass("default").prop("readonly",true);}function showAfterPay(b){var a='<p class="text-right"><a class="i-layerout-close JS_close_layerout" onclick="window.lock = false;" title="关闭" href="javascript:;"></a></p><p style="text-align:center; font-size:14px; color:#333;padding:30px 0;"><i class="i-l-notice"></i>请你在新打开的页面上完成付款，付款完成前请不要关闭此窗口！</p><p class="text-center" style="font-size:14px;">完成付款后请根据你的情况点击以下按钮。</p>';$.LayerOut({html:a,closeByShadow:false,handlers:[{title:'<i class="i-bingo"></i>我已完成付款',eventType:"click",className:"layer-button blue-button",event:function(){window.location.href=b.alipay_result_url;$._LayerOut.close();}},{title:"支付遇到问题",eventType:"click",className:"layer-button grey-button",event:function(){window.location.href=b.alipay_result_url;$._LayerOut.close();}}]});}function payOrderAjax(a,c){if(!a){window.lock=false;return false;}c=c||{};var b=window.open();b.opener=null;b.open("","_self","");$.get(a,c,function(d){if(d&&d.status=="ok"){b.location=d.alipay_url;showAfterPay(d);}else{if(d&&d.msg){$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>'+d.msg+"</p>");window.lock=false;b.close();}else{$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>请求出错了，刷新页面再试一下吧！</p>');b.close();window.lock=false;}}});}function confirmOrderAjax(a,b){if(!a){window.lock=false;return false;}b=b||{};$.post(a,b,function(c){if(c&&c.status=="ok"){$("#JS_agree_agreement").prop("checked",false);window.location.href=c.redirect_url;}else{if(c&&c.msg){$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>'+c.msg+"</p>");window.lock=false;}else{$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>请求出错了，刷新页面再试一下吧！</p>');window.lock=false;}}});}$(function(){var d=$("#JS_bill_form"),b=d.attr("action");$("#JS_save_bill_btn").click(function(){var f=$(this),g={csrfmiddlewaretoken:$('input[name="csrfmiddlewaretoken"]').val(),bill_type:$('input[name="bill_type"]:checked').val(),content:$('input[name="content"]').val(),title:$('input[name="title"]').val()};if(!g.csrfmiddlewaretoken){$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>非法操作！</p>');return false;}if(!g.content){$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>没有内容！</p>');return false;}if(!g.bill_type){$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>请选择抬头类型！</p>');return false;}$.post(b,g,function(h){if(h&&h.status=="ok"){$("#JS_saved_bill").text(g.bill_type=="company"?"单位":"个人");$("#JS_saved_title").text(g.title);$("#JS_saved_content").text(g.content);f.hide();$("#JS_notneed_invoice").hide();$("#JS_edit_invoice").show();$("#JS_saveed_info").show().siblings().hide();invoiceId=h.id;$("#JS_receiver_box").show();}else{if(h.msg){$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>'+h.msg+"</p>");}else{$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>保存失败，请稍后再试！</p>');}}});});$(document).on("click","#JS_view_agreement",function(){var f=$("#JS_agreement").html();$.LayerOut({html:f});});$("#JS_edit_invoice").on("click",function(){$(this).hide().siblings().show();$("#JS_saveed_info").hide().siblings().show();});$(document).on("click",".JS_form_radio",function(){var g=$(this),f=$("#JS_bill_title");console.log(g.attr("data-company"),f);if(g.attr("data-company")){f.show();}else{f.hide().val("");}g.find("i").addClass("active").end().find("input").prop("checked",true).end().closest("p").siblings().find(".JS_form_radio").find("i").removeClass("active").end().find("input").prop("checked",false);});$(document).on("click","#JS_receiver>div",function(){var f=$(this);if(f.hasClass("add-address")){f.find("div").show();}else{$(".add-address").find("div").hide();}f.find("i").addClass("active").end().siblings().find("i").removeClass("active").end().not(".add-address").find(".JS_cancel_edit").each(function(){resetInput($(this));});});var a=$("#JS_save_receiver_form"),e=a.attr("action");$("#JS_save_receiver_btn").click(function(){if(window.receiver_btn_lock){return;}window.receiver_btn_lock=true;var j=$(this),i=$(".add-address"),h=i.find('input[name^="name"]').val(),g=i.find('input[name^="address"]').val(),f=i.find('input[name^="phone"]').val(),k=$("#JS_address_csrf").val();if(!h||!g||!f){$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>收件人信息不完整！</p>');window.receiver_btn_lock=false;return false;}if(!/^\d+$/g.test(f)){$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>联系格式不对！</p>');window.receiver_btn_lock=false;return false;}$.post(e,{name:h,address:g,phone:f,csrfmiddlewaretoken:k},function(m){if(m&&m.status=="ok"){var l='<div class="p10x0" data-id="'+m.id+'" data-edit_url="'+m.edit_url+'" data-delete_url="'+m.delete_url+'"><label class="toggle-radio ml10"><i class="i-radio active"></i></label><input class="input w70 inline default" readonly="" type="text" name="name_'+m.id+'" value="'+h+'"> <input class="input w100 inline default" type="text" readonly="" name="phone_'+m.id+'" value="'+f+'"><input class="input w150 inline default" type="text" readonly="" name="address_'+m.id+'" value="'+g+'"> <a href="javascript:;" title="编辑" class="blue-btn JS_edit_address ml10">编辑</a><a href="javascript:;" title="编辑" class="blue-btn JS_save_address none ml10" style="display: none;">保存</a><a href="javascript:;" title="编辑" class="grey-btn JS_cancel_edit none ml10" style="display: none;">取消</a><a href="javascript:void(0);" title="删除" class="blue-btn JS_remove_address ml10" delete_url="/payment/delete_receiver_info/13/">删除</a></div>';$(".add-address").before(l);$(".add-address").find("div").hide().end().find("i").removeClass("active").end().find("input").val("");}else{if(m.msg){$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>'+m.msg+"</p>");}else{$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>保存失败，请稍后再试！</p>');}}window.receiver_btn_lock=false;},"json").fail(function(){window.receiver_btn_lock=false;});});$(document).on("click",".JS_edit_address",function(){$(this).hide().siblings(".JS_save_address,.JS_cancel_edit").show().end().siblings("input").removeClass("default").prop("readonly",false).parent().siblings().not(".add-address").find("input").addClass("default").prop("readonly",true);});$(document).on("click",".JS_cancel_edit",function(f){resetInput($(this));});$(document).on("click",".JS_save_address",function(){var j=$(this),i=j.siblings("input[name^=name_]").val(),g=j.siblings("input[name^=address_]").val(),f=j.siblings("input[name^=phone_]").val(),h=j.parent().attr("data-edit_url"),l=j.parent().attr("data-id"),k=$("#JS_address_csrf").val();if(!i||!g||!f){$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>收件人信息不完整！</p>');return false;}if(!/^\d+$/g.test(f)){$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>联系格式不对！</p>');return false;}$.post(h,{name:i,address:g,phone:f,id:l,csrfmiddlewaretoken:k},function(m){if(m&&m.status=="ok"){resetInput(j.siblings(".JS_cancel_edit"));}else{if(m.msg){$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>'+m.msg+"</p>");}else{$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>保存失败，请稍后再试！</p>');}}},"json");});$(document).on("click",".JS_remove_address",function(h){var g=$(this),f=g.attr("delete_url");$.get(f,function(i){if(i&&i.status=="ok"){g.parent().remove();}},"json");h.stopPropagation();});$("#JS_notneed_invoice").on("click",function(){$(this).closest(".invoice").hide().next().show();$("#JS_receiver_box").hide();invoiceId=null;});$("#JS_need_invoice").on("click",function(){$(this).closest(".invoice").hide().prev().show();});$(document).on("change","#JS_agree_agreement",function(){var f=$("#JS_confirm_pay_btn, #JS_confirm_order_pay");if($(this).prop("checked")){f.removeClass("disabled");}else{f.addClass("disabled");}});var c=$("#JS_address_csrf").attr("value");$("#JS_confirm_pay_btn").click(function(){if(window.lock){return false;}window.lock=true;if(!$("#JS_agree_agreement").prop("checked")){window.lock=false;return false;}var f=$(this).attr("data-confirm_pay_url"),g=$("#JS_receiver").find("i.active").parent().parent().attr("data-id"),h={};if(!g){$.alert('<p style="text-align:center;font-size:16px;"><i class="i-l-notice"></i>请先保存收件人信息</p>');window.lock=false;return false;}h={need_bill:invoiceId?"yes":"no",bill_id:invoiceId,receiver_id:g,csrfmiddlewaretoken:c};confirmOrderAjax(f,h);});$("#JS_immediately_pay_btn").on("click",function(){if(window.lock){return false;}window.lock=true;var f=$(this).attr("data-confirm_pay_url");payOrderAjax(f);});$("#JS_confirm_order_pay").click(function(){if(window.lock){return false;}window.lock=true;if(!$("#JS_agree_agreement").prop("checked")){window.lock=false;return false;}else{$("#JS_agree_agreement").prop("checked",false);}});});