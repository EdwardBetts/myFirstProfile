var PB=function(){return{debug:!1,fakePromise:function(a,b){var c=$.Deferred();return void 0!=b&&"ok"==b?c.resolve(a):c.reject(a),c.promise()},et:function(a,b,c,d){a.prototype=b,b.apply(c,d)},request:function(a,b,c,d,e,f,g){var c=void 0!=c&&"string"==typeof c&&"post"==c?"post":"json",g=void 0!=g&&"string"==typeof g&&"post"==g?"post":"json",a=void 0!=a&&"string"==typeof a&&"post"==a?"post":"get",h=function(a){var b="";for(var c in a)a.hasOwnProperty(c)&&(b+=""==b?""+c+"="+a[c]:"&"+c+"="+a[c]);return b},i=function(a){var b=document.cookie.match("(^|;) ?"+a+"=([^;]*)(;|$)");return b?b[2]:null},j={url:b,type:a,cache:!1,headers:{"X-CSRFToken":i("csrftoken")},success:function(a){"function"==typeof d&&d(a)},error:function(a,b){"function"==typeof e&&e(a,b)}};"json"==c&&(j.dataType="json"),"post"==a&&("json"==g?(j.headers["Content-Type"]="application/json",j.data=JSON.stringify(f)):j.data=h(f));return $.ajax(j)},formErrHandler:function(a,b,c,d,e){var f=this,g=a.errors;if(g){console.log("errors",g);var h=0;for(var i in g){if(g.hasOwnProperty(i)){0==h&&("code"==i&&0==$("#"+i).length?$("#smscode").length?$("#smscode").focus():$("#code-email").length&&$("#code-email").focus():"email"==i&&0==$("#"+i).length?$("#to-chg-email").length&&$("#to-chg-email").focus():"phone"==i&&0==$("#"+i).length?$("#new-phone").length&&$("#new-phone").focus():$("#"+i).focus());var j="object"==typeof g[i]?g[i][0]:g[i];"code"==i&&0==$("#"+i).length?$("#smscode").length?$("#smscode-error").html(j).css("display","block"):$("#code-email").length&&($("#code-email-title-error").css("display","block"),$("#code-email-error").html(j).css("display","block")):"email"==i&&0==$("#"+i).length?$("#to-chg-email").length&&($("#to-chg-email-title-error").css("display","block"),$("#to-chg-email-error").html(j).css("display","block")):"phone"==i&&0==$("#"+i).length?$("#new-phone").length&&($("#new-phone-title-error").css("display","block"),$("#new-phone-error").html(j).css("display","block")):($("#"+i+"-error").html(j).css("display","block"),$("#"+i+"-title-error").length&&$("#"+i+"-title-error").css("display","block"))}h++}"function"==typeof c&&c(a)}else void 0!=a.status&&"ok"!=a.status?void 0!=d&&f.btnAlert(d,a.msg,e):"function"==typeof b&&b(a)},func:function(){},captcha:function(a){$(a).html('<img title="\u770b\u4e0d\u8bf7\uff1f\u70b9\u51fb\u5237\u65b0" name="code" src="/users/get_check_code_image/" alt="\u70b9\u51fb\u5237\u65b0" width="135px" height="40px" />'),$(a).find("img").on("click",function(a){var b=$(this).attr("src")+"?t="+ +new Date;$(this).attr("src",b)})},box:function(a,b,c,d,e,f,g,h){var i=this;if($.LayerOut({closeByShadow:!1,html:a}),i.close=function(){$(".modal-backdrop,.modal").remove(),delete $._LayerOut},a.match(/use\-captcha/i)&&i.captcha(".no-feed-alert .use-captcha"),a.match(/use\-sms\-code/i)&&void 0!=e)i.smsCodeHtml(".no-feed-alert .use-sms-code",e,g,f,h);else if(a.match(/use\-email\-code/i)&&void 0!=e&&e.match(/ /i)){var j=[];"string"==typeof e&&(j=e.split(" ")),2==j.length&&i.emailCodeHtml(".no-feed-alert .use-email-code",j[0],j[1],g,f)}$(".closeLayer").on("click",function(){$(".modal-backdrop,.modal").remove(),delete $._LayerOut,"function"==typeof d&&d($(this))}),$(b).on("click",function(){"function"==typeof c&&c($(this),i)})},btnAlert:function(a,b,c,d){var e=$(a).html();void 0!=c&&"string"==typeof c&&(e=c);var d=void 0!=d&&"string"==typeof d?d:"#cccccc",f=$(a).css("background-color");$(a).css("background-color",d),$(a).html("").hide(),$(a).html('<span class="error">'+b+"</span>").fadeIn(200).delay(1e3).fadeOut(200,function(){$(a).css("background-color",f),$(a).html(e).fadeIn(200)})},getSmsCode:function(a,b,c,d){var e=this,d=void 0!=d&&"string"==typeof d?d:"AccountReg";$(".smscode").focus();var f=e.request("post","/users/send_sms_code/","json",function(a){e.formErrHandler(a,function(a){return!0},null,b,c)},function(a,d){e.formErrHandler(a,function(a){return!1},null,b,c)},{action_name:d,mobile:a},"json");return f},smsCodeHtml:function(a,b,c,d,e){var f=this;$(a).append('<button type="button" class="btn btn-blue-submit-small smscode"><span>\u83b7\u53d6\u9a8c\u8bc1\u7801</span></button>');var g=$(".smscode",a).html();$(a).undelegate(".smscode","click").delegate(".smscode","click",function(h){var i=$(this),j=60;if(!$("#"+b).prop("value").match(/^1[0-9]{10}$/i))return $("#"+b+"-error").length?$("#"+b+"-error").text("\u8bf7\u8f93\u5165\u624b\u673a\u53f7\u7801\uff01").show():f.btnAlert(".smscode","\u8bf7\u8f93\u5165\u624b\u673a\u53f7\u7801\uff01",g),!1;$("#"+b+"-error").length&&($("#"+b+"-error").text("").hide(),$("#"+b+"-title-error").hide());var l,k=$("#"+b).prop("value"),m=!1,n=0;return i.prop("disabled")||(l=f.getSmsCode(k,".smscode",g,e),l.fail(function(){m=!0})),i.prop("disabled",!0),$(".smscode",a).html('<span><span class="count-down">'+j+"</span>s\u540e\u91cd\u65b0\u83b7\u53d6</span>"),c=setInterval(function(){var b=$(".smscode .count-down",a).text();b.match(/[0-9]/i)||(b="0"),n=parseInt(b),n--,0>=n?(clearInterval(c),i.prop("disabled",!1),m||$(".smscode",a).html(g),d=!0):$(".smscode .count-down",a).text(n)},1e3),!1})},getEmailCode:function(a,b,c,d){var e=this;$(".emailcode").focus();var f=e.request("post","/users/send_email_code/","json",function(a){e.formErrHandler(a,function(a){return!0},null,c,d)},function(a,b){e.formErrHandler(a,function(a){return!1},null,c,d)},{password:a,email:b},"json");return f},emailCodeHtml:function(a,b,c,d,e){var f=this;$(a).append('<button type="button" class="btn btn-blue-submit-small emailcode"><span>\u83b7\u53d6\u90ae\u7bb1\u9a8c\u8bc1\u7801</span></button>');var g=$(".emailcode",a).html();$(a).undelegate(".emailcode","click").delegate(".emailcode","click",function(h){var i=$(this),j=60;if($("#"+b).prop("value").trim().length<6)return $("#"+b+"-error").length?$("#"+b+"-error").text("\u8bf7\u8f93\u5165\u767b\u5f55\u5bc6\u7801\uff01").show():f.btnAlert(".emailcode","\u8bf7\u8f93\u5165\u767b\u5f55\u5bc6\u7801\uff01",g),!1;if(!f.isValidEmail($("#"+c).prop("value")))return $("#"+c+"-error").length?$("#"+c+"-error").text("\u8bf7\u8f93\u5165\u90ae\u7bb1\uff01").show():f.btnAlert(".emailcode","\u8bf7\u8f93\u5165\u90ae\u7bb1\uff01",g),!1;$("#"+b+"-error").length&&($("#"+b+"-error").text("").hide(),$("#"+b+"-title-error").hide(),$("#"+c+"-error").text("").hide(),$("#"+c+"-title-error").hide());var m,k=$("#"+b).prop("value"),l=$("#"+c).prop("value"),n=!1,o=0;return i.prop("disabled")||(m=f.getEmailCode(k,l,".emailcode",g),m.fail(function(){console.log("promise_err",m),n=!0})),i.prop("disabled",!0),$(".emailcode",a).html('<span><span class="count-down">'+j+"</span>s\u540e\u91cd\u65b0\u83b7\u53d6</span>"),d=setInterval(function(){var b=$(".emailcode .count-down",a).text();b.match(/[0-9]/i)||(b="0"),o=parseInt(b),o--,0>=o?(clearInterval(d),i.prop("disabled",!1),n||$(".emailcode",a).html(g),e=!0):n||$(".emailcode .count-down",a).text(o)},1e3),!1})},formSerializeToObject:function(a){var b=a.serializeArray(),c={},d=function(a){var b=document.cookie.match("(^|;) ?"+a+"=([^;]*)(;|$)");return b?b[2]:null};return $.map(b,function(a,b){var e=a.name;if(c.hasOwnProperty(e)){var f=c[e];"object"==typeof c[e]?c[e].push(a.value.trim()):(c[e]=[],c[e].push(f),c[e].push(a.value.trim()))}else c[e]=a.value.trim();if("select_fields"==e&&"string"==typeof c[e]){var f=c[e];c[e]=[],c[e].push(f)}if(!c.hasOwnProperty("next")&&document.location.href.toString().match(/next=([0-9a-z_#&:=%\/\.\-]+)/i)){var g=RegExp.$1;c.next=g}c.hasOwnProperty("csrftoken")&&c.csrftoken!=d("csrftoken")&&(c.csrftoken=d("csrftoken")),c.hasOwnProperty("csrfmiddlewaretoken")&&c.csrfmiddlewaretoken!=d("csrftoken")&&(c.csrfmiddlewaretoken=d("csrftoken"))}),c},isValidEmail:function(a){return null!=a.match(/^[0-9a-z\._\+\-]+@[0-9a-z\._\+\-]+$/i)},validateFormSubmit:function(a,b,c,d,e,f,g,h){var i=this,h=void 0!=h&&"string"==typeof h?h:"json";a.validate(b);if($btn=$(c),a.valid()){$btn.attr("disabled","true");var k=i.formSerializeToObject(a);"function"==typeof d&&(k=d(k));var l=i.request("post",e,"json",function(a){$btn.removeAttr("disabled"),i.formErrHandler(a,function(a){"function"==typeof f&&f(a)},null,c,g)},function(a,b){return i.btnAlert(c,"\u7cfb\u7edf\u9519\u8bef\uff0c\u65e0\u6cd5\u767b\u5f55\u3002",g),!1},k,h);return l}},modalLine3Col:function(a,b,c,d,e,f){var c=void 0!=c&&"string"==typeof c&&"password"==c?"password":"text",d=void 0!=d&&"string"==typeof c?d:"",e=void 0!=e&&"string"==typeof e?e:"",f=void 0!=f&&"string"==typeof f?f:"",g="";return g+=d?'<p class="tip line '+e+'"><span class="line-title line-width-33">'+a+'\uff1a</span><span class="line-input line-width-33"><input type="'+c+'" class="'+b+' dark-border" name="'+b+'" id="'+b+'" value="'+f+'"></span><span class="line-input line-width-33 '+d+'"></span><span id="'+b+'-title-error" class="line-title line-width-33 invalid" style="display:none;"></span><span id="'+b+'-error" class="line-input line-width-66 invalid" style="display:none;"></span></p>':'<p class="tip line '+e+'"><span class="line-title line-width-33">'+a+'\uff1a</span><span class="line-input line-width-66"><input type="'+c+'" class="'+b+' dark-border" name="'+b+'" id="'+b+'" value="'+f+'"></span><span id="'+b+'-title-error" class="line-title line-width-33 invalid" style="display:none;"></span><span id="'+b+'-error" class="line-input line-width-66 invalid" style="display:none;"></span></p>'},chgNotifyEmail:function(a,b,c){var d=this,e="\u786e\u8ba4\u4fee\u6539",f=$(".current-email").text();d.isValidEmail(f)||(f="");var g='<div class="no-feed-alert"><h2><i class="i-warning"></i>\u4fee\u6539\u7b80\u5386\u63a5\u6536\u90ae\u7bb1</h2>'+d.modalLine3Col("\u8bf7\u8f93\u5165\u767b\u5f55\u5bc6\u7801","login-passwd","password",null,"mg-top-30")+d.modalLine3Col("\u8bf7\u8f93\u5165\u65b0\u7684\u90ae\u7bb1","to-chg-email","text",null,null,f)+d.modalLine3Col("\u8bf7\u8f93\u5165\u90ae\u7bb1\u9a8c\u8bc1\u7801","code-email","text","use-email-code")+'<p class="tip line mg-bottom-30"><span class=" line-width-100">\u8be5\u90ae\u7bb1\u4ec5\u7528\u4e8e\u63a5\u6536\u7b80\u5386\u63a8\u8350\uff0c\u4e0d\u7528\u4e8e\u767b\u5f55\uff0c\u60a8\u53ef\u81f3\u201c<a class="c42b4e6" href="/users/profile/">\u4e2a\u4eba\u8bbe\u7f6e</a>\u201d\u4e2d\u4fee\u6539</span></p><p><a class="btn confirm chg-email-now" href="javascript:void(0);">\u786e\u8ba4\u4fee\u6539</a></p></div>';d.box(g,".chg-email-now",function(a,b){var f=a.parent().parent().find(".to-chg-email").prop("value"),g=a.parent().parent().find(".code-email").prop("value"),h=a.parent().parent().find(".login-passwd").prop("value");return""==$.trim(h)?(d.labelErr("login-passwd","\u8bf7\u8f93\u5165\u767b\u5f55\u5bc6\u7801\uff01"),a.parent().parent().find(".login-passwd").focus(),!1):d.isValidEmail(f)?""==$.trim(g)?(d.labelErr("code-email","\u8bf7\u8f93\u5165\u90ae\u7bb1\u9a8c\u8bc1\u7801\uff01"),a.parent().parent().find(".code-email").focus(),!1):($(".chg-email-now").attr("disabled","true"),void d.request("post","/users/change_notify_email/","json",function(a){$(".chg-email-now").removeAttr("disabled"),"function"==typeof c?c(a):d.formErrHandler(a,function(a){b.close(),document.location.href="/users/profile/"},null,".chg-email-now","\u786e\u8ba4\u4fee\u6539")},function(a,b){return d.btnAlert(".chg-email-now","\u4fee\u6539\u63a5\u6536\u5931\u8d25\uff01\u8bf7\u91cd\u65b0\u83b7\u53d6",e),!1},{password:h,code:g,email:f},"json")):(d.labelErr("to-chg-email","\u8bf7\u8f93\u5165\u8981\u65b0\u7684\u90ae\u7bb1\uff01"),a.parent().parent().find(".to-chg-email").focus(),!1)},null,"login-passwd to-chg-email",a,b)},countDown:function(a,b){$(a+" .jumpTo").length&&(console.log("countDown",$(a+" .jumpTo").length),timeInterval=setInterval(function(){var c=$(a+" .jumpTo").text();c.match(/[0-9]/i)||(c="0"),countDownLeft=parseInt(c),countDownLeft--,countDownLeft<=0?(clearInterval(timeInterval),document.location.href=b):$(a+" .jumpTo").text(countDownLeft)},1e3))},chgMobile:function(a,b,c,d,e){var f=this,g='<div class="no-feed-alert"><h2><i class="i-warning"></i>'+a+"</h2><br><br>"+f.modalLine3Col("\u8bf7\u8f93\u5165\u767b\u5f55\u5bc6\u7801","login-passwd","password")+f.modalLine3Col("\u8bf7\u8f93\u5165\u65b0\u7684\u624b\u673a\u53f7\u7801","new-phone")+f.modalLine3Col("\u8bf7\u8f93\u5165\u77ed\u4fe1\u9a8c\u8bc1\u7801","code","text","use-sms-code")+'<br><p><a class="btn confirm '+c+'-now" href="javascript:void(0);">'+b+"</a></p></div>";f.box(g,"."+c+"-now",function(a,b){var d=a.parent().parent().find(".code").prop("value"),e=a.parent().parent().find(".new-phone").prop("value"),g=a.parent().parent().find(".login-passwd").prop("value");if(""==$.trim(g))return f.labelErr("login-passwd","\u8bf7\u8f93\u5165\u767b\u5f55\u5bc6\u7801\uff01"),a.parent().parent().find(".login-passwd").focus(),!1;if(!e.match(/^1[0-9]{10}$/i))return f.labelErr("new-phone","\u8bf7\u8f93\u5165\u65b0\u7684\u624b\u673a\u53f7\u7801\uff01"),a.parent().parent().find(".new-phone").focus(),!1;if(!d.match(/^[0-9]{6}$/i))return f.labelErr("sms-code","\u8bf7\u8f93\u5165\u516d\u4f4d\u77ed\u4fe1\u9a8c\u8bc1\u7801\uff01"),a.parent().parent().find(".sms-code").focus(),!1;$(".sms-code").html();$("."+c+"-now").attr("disabled","true"),PB.request("post","/users/change_mobile/","json",function(a){$("."+c+"-now").removeAttr("disabled"),PB.formErrHandler(a,function(a){console.log("change_mobile",a),b.close(),document.location.href="/users/profile/"},null,"."+c+"-now","\u786e\u8ba4\u4fee\u6539")},function(a,b){return PB.btnAlert("."+c+"-now","\u4fee\u6539\u7ed1\u5b9a\u624b\u673a\u5931\u8d25\uff01\u8bf7\u91cd\u65b0\u83b7\u53d6"),!1},{password:g,mobile:e,code:d},"json")},null,"new-phone",d,e,"ChangeMobile")},labelErr:function(a,b){if($("#"+a+"-error").length){var b=void 0!=b&&"string"==typeof b?b:"";""==b?($("#"+a+"-error").text(b).css("display","none"),$("#"+a+"-title-error").css("display","none")):($("#"+a+"-error").text(b).css("display","block"),$("#"+a+"-title-error").css("display","block"))}$("#"+a).on("blur",function(){""!=$(this).prop("value").trim()&&($("#"+a+"-error").text("").css("display","none"),$("#"+a+"-title-error").css("display","none"))})}}}();